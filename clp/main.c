#include <stdio.h>
#include <stdlib.h>
#include <GLUT/glut.h> 
//#include <GL/glut.h>//Drawing funciton

#define KEY_ESC 27
#define WINDOW_POS_X 100
#define WINDOW_POS_Y 100
#define DEF_SCREEN_WIDTH 1224 
#define DEF_SCREEN_HEIGHT 700 

static int width = 0;
static int height = 0;
static int herox = 100;
static int heroy = 100;
static float hero_speed = 0.0f;

static GLubyte *buffer = NULL;
static int fullscreen = 0;

static void
keyboard(unsigned char c, int x, int y)
{
  if(c == 'h' || c == 'l') {
    if(hero_speed < 8) {
      hero_speed += 0.3;
    }
  }
  if(c == 'k') {
    heroy = heroy - 4 - hero_speed;
  }
  if(c == 'j') {
    heroy = heroy + 4 + hero_speed;
  }
  if(c == 'h') {
    herox = herox - 4 - hero_speed;
  }
  if(c == 'l') {
    herox = herox + 4 + hero_speed;
  }
  if(c == KEY_ESC) {
    exit(0);
  }
  if(c == 'f') {
    if (fullscreen) {
      glutReshapeWindow(DEF_SCREEN_WIDTH, DEF_SCREEN_HEIGHT);
      glutPositionWindow(WINDOW_POS_X, WINDOW_POS_Y);
      fullscreen = 0;
    } else {
      glutFullScreen();
      fullscreen = 1;
    }
  }
}

void
idle()
{
  glutPostRedisplay();
}

static void
reshape(int w, int h)
{
  width = w;
  height = h;

  if (buffer) {
    free(buffer);
  }
  buffer = (GLubyte *)malloc(width * height * 4);
  if (!buffer) {
    abort();
  }
}


/*
0 – black (#000000) 000000  0
1 – blue (#0000AA)  000001  1                             0 0 170
2 – green (#00AA00) 000010  2                             0 170 0
3 – cyan (#00AAAA)  000011  3                             0 170 170
4 – red (#AA0000) 000100  4                               170 0 0
5 – magenta (#AA00AA) 000101  5                           170 0 170
6 – brown (#AA5500) 010100  20                            170 85 0
7 – white / light gray (#AAAAAA)  000111  7               170 170 170
8 – dark gray / bright black (#555555)  111000  56        85 85 85
9 – bright blue (#5555FF) 111001  57                      85 85 255
10 – bright green (#55FF55) 111010  58                    85 255 85
11 – bright cyan (#55FFFF)  111011  59                    85 255 255
12 – bright red (#FF5555) 111100  60                      255 85 85
13 – bright magenta (#FF55FF) 111101  61                  255 85 255
14 – bright yellow (#FFFF55)  111110  62                  255 255 85  
15 – bright white (#FFFFFF) 111111  63                    255 255 255
*/

static int ega[16][3] = {{0,0,0},{0,0,170},{0,170,0},{0,170,170},{170,0,0},
                         {170,0,170},{170,85,0},{170,170,170},{85,85,85},
                         {85,85,255}, {85,255,85},{85,255,255},{255,85,85},
                         {255,85,255},{255,255,85},{255,255,255}};

static void
draw_pixel(int x, int y, int color) 
{
  int base = 4 * ((height - 1 - y) * width + x);
  if(base < 0 || base > 4 * height * width) {
    return;
  }
  int div = 1;
  if(rand() % 100 < 10) {
    div = 2;
  }
  buffer[base + 0] = ega[color][0] / div;
  buffer[base + 1] = ega[color][1] / div;
  buffer[base + 2] = ega[color][2] / div;
  buffer[base + 3] = 0;
}

static int block_size = 289;
static int symbol_blank[289] = 
     {-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9}; 

static int symbol_colortest[289] = 
     { 0, 0, 0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
       0, 0, 0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
       0, 0, 0, 1, 1, 2, 3, 4, 4, 8, 8,13,13,15,15,-1,-9, 
      -1, 1, 1, 1, 1, 2, 3, 4, 4, 8, 8,13,13,15,15,-1,-9, 
      -1, 1, 1, 1, 1, 2, 3, 4, 4, 8, 8,13,13,15,15,-1,-9, 
      -1, 2, 2, 2, 2, 2, 3, 4, 4, 8, 8,13,13,15,15,-1,-9, 
      -1, 2, 2, 2, 2, 2, 3, 4, 4, 7, 7,12,12,15,15,-1,-9, 
      -1, 3, 3, 3, 3, 3, 3, 4, 4, 7, 7,12,12,15,15,-1,-9, 
      -1, 4, 4, 4, 4, 4, 4, 4, 4, 7, 7,12,12,15,15,-1,-9, 
      -1, 4, 4, 4, 4, 4, 4, 4, 4, 7, 7,12,12,15,15,-1,-9, 
      -1, 5, 5, 5, 5, 6, 6, 6, 6, 7, 7,12,12,15,15,-1,-9, 
      -1, 5, 5, 5, 5, 6, 6, 6, 6, 7, 7,12,12,15,15,-1,-9, 
      -1, 9, 9, 9, 9,10,10,10,10,11,11,11,11,15,15,-1,-9, 
      -1, 9, 9, 9, 9,10,10,10,10,11,11,11,11,15,15,-1,-9, 
      -1,14,14,14,14,14,14,14,14,14,14,14,14,15,15,-1,-9, 
      -1,14,14,14,14,14,14,14,14,14,14,14,14,15,15,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9}; 


static int symbol_hero[289] = 
     {-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1, 7, 7, 7, 7,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,14,14,14,14, 7, 7,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,14,14, 1, 1,14,-1,-1,-1,-1, 7,-9, 
      -1,-1,-1,-1,-1,-1,14,14, 1, 1,14,-1,-1,-1,-1, 7,-9, 
      -1,-1,-1,-1,-1,-1,14,14,14,14,14,-1,-1,-1, 7,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1, 4,14,14,-1,-1,-1,-1, 7,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1, 4, 4, 4,-1,-1,-1, 7,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1, 4, 4, 4,-1,-1,-1, 7,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1, 4, 4, 4, 4, 4, 4,14,14,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1, 4, 4, 4, 4, 4, 4, 4,14,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1, 4, 4, 4,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1, 6, 6, 6,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1, 6, 6, 6, 6,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1, 6, 6, 6, 6, 6,-1,-1,-1,-1,-1,-9}; 

static int symbol_skeleton[289] = 
     {-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1, 1, 1, 1, 1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1, 1, 1,-1, 1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1, 1,-1,-1, 1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1, 1, 1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1, 1, 1, 1,-1, 1, 1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1, 1, 1, 1, 1,-1, 1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1, 1, 1, 1, 1, 1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1, 1, 1,-1,-1, 1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1, 1, 1, 1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1, 1, 1, 1, 1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9}; 

static int symbol_bat[289] = 
     {-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1, 4,-1, 4, 4,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1, 4, 4, 4, 4, 4, 4, 4, 4,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1, 4,-1, 4, 4,-1, 4,-1, 4,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1, 4,-1,-1, 4,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9, 
      -1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-9}; 

draw_symbol(int x, int y, int symbol[]) {
  int i,ri,ci,ti; 
  ci = 0;
  ri = 0;
  ti = block_size; 
  for(i = 0; i < ti; i++) {
    if(symbol[i] == -9) {
      ri++;
      ci = 0;
      continue;
    } else if(symbol[i] != -1) {
      draw_pixel(x + ci, y + ri,symbol[i]);
      ci++;
    } else {
      ci++;
    }
  } 
}

static void
display()
{
  if(hero_speed > 0) {
    hero_speed -= 0.07;
  }
  int x,y;
  for(x = 0; x < DEF_SCREEN_WIDTH; x++) {
    for(y = 0; y < DEF_SCREEN_HEIGHT; y++) {
      if(rand() % 100 < 40) {
        if(x < 100 && y < 100) {
          draw_symbol(x,y, symbol_hero);
        }
        draw_pixel(x, y, 0);
      }
    }
  }

  draw_symbol(herox,heroy, symbol_hero);
  glWindowPos2i(0, 0);
  glDrawPixels(width, height, GL_RGBA, GL_UNSIGNED_BYTE, buffer);
  glutSwapBuffers();
  glFlush();
}

int
main(int argc, char** argv)
{
  //srand(0);
  reshape(DEF_SCREEN_WIDTH, DEF_SCREEN_HEIGHT);
  glutInit(&argc, argv);
  glutInitDisplayMode(GLUT_DOUBLE | GLUT_RGB | GLUT_DEPTH );
  glutInitWindowSize(DEF_SCREEN_WIDTH, DEF_SCREEN_HEIGHT);
  glutInitWindowPosition(WINDOW_POS_X, WINDOW_POS_Y);
  glutCreateWindow(argv[0]);
  glutKeyboardFunc(keyboard);
  glutIdleFunc(idle);
  glutReshapeFunc(reshape);
  glutDisplayFunc(display);

  glClearColor(0.0, 0.0, 0.0, 0.0);
  glShadeModel(GL_FLAT);

  glutMainLoop();
  return 0;
}
